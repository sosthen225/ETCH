{% extends 'index.html' %}
{% load static %}
{% block content %}

<!-- CSS DataTables + Buttons + FixedHeader -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css ">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css ">
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css ">

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js "></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js "></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js "></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js "></script>
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js "></script>

<div class="container mt-4">
    <h3 class="text-center mb-4">Liste des tâches des projets en cours</h3>

    <table id="activitesTable" class="display nowrap table table-bordered" style="width:100%">
        <thead class="thead-dark">
            <tr>
                <th>Tâches</th>
                <th>Livrables</th>
                <th>Équipes affectées</th>
                <th>Membres affectés</th>
                <th>Date de début</th>
                <th>Projet</th>
                <th>Chef de projet</th>
                <th>Statut de la tâche</th>
                
            </tr>
        </thead>
        <tbody>
            {% for activite in activites %}
            <tr data-id="{{ activite.id }}">
                <td>{{ activite.nom }}</td>
                <td>
                    <ul class="mb-0 ps-3">
                        {% for livrable in activite.livrables.all %}
                            <li>{{ livrable.nom_livrable }}</li>
                        {% empty %}
                            <li>Aucun livrable</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <ul class="mb-0 ps-3">
                        {% for realisation in activite.equipes_realisation.all %}
                            <li>{{ realisation.equipe.nom }}</li>
                        {% empty %}
                            <li>Non attribuée</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <ul class="mb-0 ps-3">
                        {% for effectuer in activite.personnels_affectes.select_related %}
                            <li>{{ effectuer.membre.personnel.nom|default:"Inconnu" }}<br>{{ effectuer.membre.personnel.prenoms }}</li>
                        {% empty %}
                            <li>Toute l'équipe</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>{{ activite.date_debut|date:"d/m/Y" }}</td>
                <td>{{ activite.projet.nom }}</td>
                <td>{{ activite.projet.chef_projet.user.get_full_name }}</td>
                <td>
                    <select class="form-select form-select-sm statut-select" data-id="{{ activite.id }}" data-old="{{ activite.statut }}">
                        {% for key, label in statut_choices %}
                            <option value="{{ key }}" {% if activite.statut == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </td>
                
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
$(document).ready(function () {
    $('#activitesTable').DataTable({
        responsive: true,
        scrollY: '500px',
        scrollX: true,
        scrollCollapse: true,
        fixedHeader: true,
        paging: true,
        dom: 'Bfrtip',
        buttons: [{
            extend: 'excelHtml5',
            text: 'Exporter en Excel',
            className: 'btn btn-success mb-3'
        }],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json"
        }
    });
});

// Gestion du changement de statut
$(document).on('change', '.statut-select', function () {
    const $select = $(this);
    const activiteId = $select.data('id');
    const nouveauStatut = $select.val();

    $.ajax({
        url: `/activites/${activiteId}/changer-statut/`,
        method: 'POST',
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        data: {
            statut: nouveauStatut
        },
        success: function (response) {
            if (response.success) {
                $select.data('old', nouveauStatut);
            } else {
                alert("Erreur : " + response.message);
                $select.val($select.data('old'));
            }
        },
        error: function () {
            alert("Erreur lors de la mise à jour.");
            $select.val($select.data('old'));
        }
    });
});

// Gestion de la suppression
$(document).on('click', '.delete-btn', function () {
    const button = $(this);
    const activiteId = button.data('id');
    const row = button.closest('tr');

    if (confirm("Êtes-vous sûr de vouloir supprimer cette tâche ?")) {
        $.ajax({
            url: `/activites/${activiteId}/supprimer/`,
            method: 'POST',
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            success: function (response) {
                if (response.success) {
                    row.remove();
                    alert("Tâche supprimée !");
                } else {
                    alert("Erreur : " + response.message);
                }
            },
            error: function () {
                alert("Erreur lors de la suppression.");
            }
        });
    }
});
</script>

{% endblock %}